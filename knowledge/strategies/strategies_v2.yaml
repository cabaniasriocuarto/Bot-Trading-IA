version: 2
agresividad: "media"

global_defaults:
  timeframes: [5m, 10m, 15m]
  risk:
    risk_per_trade_pct: 0.75
    max_daily_loss_pct: 4.0
    max_drawdown_pct: 20.0
    max_positions: 12
    max_total_exposure_pct: 60.0
    max_exposure_per_symbol_pct: 12.0
  costs:
    max_spread_bps: 12
    max_slippage_bps: 8
  orderflow:
    use_obi: true
    use_cvd: true
    use_vpin: true

strategies:
  - id: trend_pullback_orderflow_v2
    name: "Tendencia + Pullback + Order Flow"
    intent: "Capturar continuidad de tendencia con entrada barata + confirmación microestructura."
    inputs:
      indicators: [EMA20, EMA50, EMA200, RSI14, ATR14, ADX14]
      orderflow: [OBI_TOPN, CVD]
      costs: [SPREAD_BPS]
    setup:
      long_trend:
        - "EMA20 > EMA50"
        - "CLOSE > EMA200"
        - "ADX14 >= 20"
      short_trend:
        - "EMA20 < EMA50"
        - "CLOSE < EMA200"
        - "ADX14 >= 20"
    trigger_5_10m:
      long:
        - "Pullback: CLOSE cerca de EMA20 (distancia <= 0.4*ATR14)"
        - "RSI14 entre 45 y 70"
        - "Ruptura del HIGH previo (confirmación de continuación)"
      short:
        - "Pullback: CLOSE cerca de EMA20 (distancia <= 0.4*ATR14)"
        - "RSI14 entre 30 y 55"
        - "Ruptura del LOW previo"
    orderflow_confirm_1m_optional:
      long:
        - "OBI_TOPN >= 0.55"
        - "CVD ventana corta > 0"
      short:
        - "OBI_TOPN <= 0.45"
        - "CVD ventana corta < 0"
    invalidation:
      - "Spread_bps > max_spread_bps"
      - "VPIN percentil > 0.90 (tóxico)"
      - "ADX cae por debajo de 16 (pierde tendencia)"
    exits:
      stop: "2.0 * ATR14"
      take_profit: "3.0 * ATR14"
      trailing:
        activate_at: "1.5 * ATR14 a favor"
        distance: "2.0 * ATR14"
      time_stop: "20 velas"
    notes:
      pitfalls:
        - "En chop, EMA cruza mucho: usar ADX y filtro régimen."
        - "Sin orderflow real: deshabilitar confirmación y subir umbral de tendencia."

  - id: breakout_volatility_v2
    name: "Breakout + Expansión de Volatilidad"
    intent: "Capturar rupturas reales (no falsas) con filtro de expansión de rango/costos."
    inputs:
      indicators: [ATR14, RSI14, EMA50]
      costs: [SPREAD_BPS]
      volume: [VOLUME]
    trigger:
      long:
        - "Breakout: CLOSE rompe máximo de ventana N (ej 20–55)"
        - "ATR14 o rango de vela muestra expansión (z-score > 1.0)"
      short:
        - "Breakout: CLOSE rompe mínimo de ventana N"
        - "Expansión de ATR/rango"
    invalidation:
      - "Spread_bps alto o slippage estimado alto"
      - "VPIN pctl > 0.92 (mucha toxicidad)"
    exits:
      stop: "1.8 * ATR14"
      take_profit: "3.2 * ATR14"
      trailing:
        activate_at: "1.2 * ATR14"
        distance: "1.8 * ATR14"
      time_stop: "16 velas"
    notes:
      pitfalls:
        - "Rupturas en horarios ilíquidos: filtrar por volumen y spread."
        - "Si fees altos, baja TP o reduce frecuencia."

  - id: meanreversion_range_v2
    name: "Mean Reversion (Rango) + Cost Aware"
    intent: "Operar sobre-extensiones en rango cuando NO hay tendencia (ADX bajo)."
    inputs:
      indicators: [EMA20, RSI14, ATR14, ADX14]
      costs: [SPREAD_BPS]
      orderflow: [VPIN_PCTL]
    regime:
      - "ADX14 <= 18"
    trigger:
      long:
        - "RSI14 <= 30"
        - "CLOSE por debajo de EMA20 al menos 0.6*ATR14"
      short:
        - "RSI14 >= 70"
        - "CLOSE por encima de EMA20 al menos 0.6*ATR14"
    invalidation:
      - "ADX sube > 22 (sale del rango)"
      - "VPIN pctl > 0.90"
      - "Spread_bps alto"
    exits:
      stop: "1.4 * ATR14"
      take_profit: "Target: EMA20 o 1.6*ATR14 (lo que ocurra primero)"
      trailing: "OFF (opcional)"
      time_stop: "10 velas"
    notes:
      pitfalls:
        - "Si se vuelve tendencia te quedás contra: por eso ADX gate."
        - "No usar en activos con spread crónico alto."

  - id: trend_scanning_regime_v2
    name: "Trend Scanning + Regímenes"
    intent: "Clasifica régimen y selecciona reglas (trend vs range vs high vol)."
    inputs:
      indicators: [ADX14, ATR14, EMA50, RSI14]
      meta: [TSCAN_TMAX]
    regime_rules:
      trend:
        when: "TSCAN_TMAX >= 1.8 y ADX14 >= 20"
        use: "trend_pullback_orderflow_v2"
      range:
        when: "TSCAN_TMAX < 1.2 o ADX14 <= 18"
        use: "meanreversion_range_v2"
      high_vol:
        when: "ATR14/ATR_baseline >= 1.6"
        use: "breakout_volatility_v2"
    invalidation:
      - "Cambios de régimen detectados por drift (CUSUM/vol-shift)"
    exits:
      stop: "hereda del sub-setup"
      take_profit: "hereda del sub-setup"
      trailing: "hereda del sub-setup"
    notes:
      pitfalls:
        - "Si el detector de régimen es ruidoso: limitar switches por día."

  - id: defensive_liquidity_v2
    name: "Defensiva: Calidad de Ejecución + Liquidez"
    intent: "Sobrevivir: operar poco, solo cuando costos son muy favorables."
    inputs:
      indicators: [ATR14, EMA50, RSI14]
      costs: [SPREAD_BPS]
      orderflow: [VPIN_PCTL, OBI_TOPN]
    rules:
      - "Solo operar si SPREAD_BPS <= 8 y VPIN_PCTL <= 0.85"
      - "Solo 1–3 posiciones máx (modo defensivo)"
    trigger:
      long:
        - "EMA50 ascendiendo + RSI entre 45 y 65 + OBI_TOPN >= 0.55"
      short:
        - "EMA50 descendiendo + RSI entre 35 y 55 + OBI_TOPN <= 0.45"
    exits:
      stop: "2.2 * ATR14"
      take_profit: "2.8 * ATR14"
      trailing:
        activate_at: "1.0 * ATR14"
        distance: "1.8 * ATR14"
      time_stop: "18 velas"
